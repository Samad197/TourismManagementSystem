@model IEnumerable<TourismManagementSystem.Models.ViewModels.AdminUserListItemVm>
@{
    ViewBag.Title = "Manage Users";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<div class="container-fluid bg-breadcrumb">
    <div class="container text-center py-5" style="max-width:900px;">
        <h3 class="text-white display-3 mb-4">Users</h3>
        <p class="text-white-50 mb-0">Activate/Deactivate, Approve providers</p>
    </div>
</div>

@Html.Partial("_Flash")

<div class="container py-4">

    <div class="row g-2 mb-3 align-items-end">
        <div class="col-md-3">
            <label class="form-label">Role</label>
            <select id="filterRole" class="form-select">
                <option value="">All</option>
                <option>Admin</option>
                <option>Agency</option>
                <option>Guide</option>
                <option>Tourist</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Active</label>
            <select id="filterActive" class="form-select">
                <option value="">All</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Approved</label>
            <select id="filterApproved" class="form-select">
                <option value="">All</option>
                <option value="Approved">Approved</option>
                <option value="Pending">Not Approved</option>
            </select>
        </div>
    </div>

    <div class="table-responsive">
        <table id="usersTable" class="table table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th>Role</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Active</th>
                    <th>Approved</th>
                    <th>Created</th>
                    <th style="width:280px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var u in Model)
                {
                    var isSelf = string.Equals(u.Email, User.Identity.Name, StringComparison.OrdinalIgnoreCase);
                    var isAdminRow = string.Equals(u.RoleName, "Admin", StringComparison.OrdinalIgnoreCase);
                    var isProvider = u.RoleName == "Agency" || u.RoleName == "Guide";

                    <tr>
                        <td>
                            <span class="badge @(u.RoleName=="Admin"?"bg-dark":u.RoleName=="Agency"?"bg-primary":u.RoleName=="Guide"?"bg-info":"bg-secondary")">
                                @u.RoleName
                            </span>
                        </td>
                        <td>@u.FullName</td>
                        <td>@u.Email</td>
                        <td>@(u.IsActive ? Html.Raw("<span class='badge bg-success'>Active</span>") : Html.Raw("<span class='badge bg-secondary'>Inactive</span>"))</td>
                        <td>@(u.IsApproved ? Html.Raw("<span class='badge bg-success'>Approved</span>") : Html.Raw("<span class='badge bg-warning text-dark'>Pending</span>"))</td>
                        <td>@u.CreatedAt.ToString("yyyy-MM-dd")</td>
                        <td class="d-flex flex-wrap gap-2">
                            <a class="btn btn-sm btn-outline-secondary" href="@Url.Action("UserDetails","Admin", new { id = u.UserId })">View</a>

                            @* Toggle Active (not self, not Admin) *@
                            @if (!isSelf && !isAdminRow)
                            {
                                using (Html.BeginForm("ToggleActive", "Admin", FormMethod.Post, new { id = $"formActive_{u.UserId}" }))
                                {
                                    @Html.AntiForgeryToken()
                                    @Html.Hidden("id", u.UserId)
                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary js-confirm-submit"
                                            data-form-id="@($"formActive_{u.UserId}")"
                                            data-title="Toggle Active"
                                            data-message="Change active status for @u.FullName?"
                                            data-variant="warning">
                                        Toggle Active
                                    </button>
                                }
                            }

                            @* Toggle Approved (only Agency/Guide, not self) *@
                            @if (isProvider && !isSelf)
                            {
                                using (Html.BeginForm("ToggleApproved", "Admin", FormMethod.Post, new { id = $"formApprove_{u.UserId}" }))
                                {
                                    @Html.AntiForgeryToken()
                                    @Html.Hidden("id", u.UserId)
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary js-confirm-submit"
                                            data-form-id="@($"formApprove_{u.UserId}")"
                                            data-title="Toggle Approval"
                                            data-message="Approve / unapprove @u.FullName?"
                                            data-variant="primary">
                                        Toggle Approved
                                    </button>
                                }
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true" aria-labelledby="confirmTitle">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmTitle">Confirm action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmMessage">Are you sure?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmYes" class="btn btn-primary">Yes, continue</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            // Initialize DataTable
            var table = $('#usersTable').DataTable({
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                ordering: true,
                responsive: true,
                columnDefs: [
                    { orderable: false, targets: [6] } // disable sorting on "Actions" column
                ],
                language: {
                    search: "Search users:",
                    lengthMenu: "Show _MENU_ users",
                    info: "Showing _START_ to _END_ of _TOTAL_ users"
                }
            });

            // Hook dropdown filters
            $('#filterRole').on('change', function () {
                table.column(0).search(this.value).draw();
            });
            $('#filterActive').on('change', function () {
                table.column(3).search(this.value).draw();
            });
            $('#filterApproved').on('change', function () {
                table.column(4).search(this.value).draw();
            });

            // Bootstrap confirm modal
            var modalEl = document.getElementById('confirmModal');
            var titleEl = document.getElementById('confirmTitle');
            var msgEl = document.getElementById('confirmMessage');
            var yesBtn = document.getElementById('confirmYes');
            var targetForm = null;
            var bsModal = new bootstrap.Modal(modalEl);

            document.querySelectorAll('.js-confirm-submit').forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    targetForm = document.getElementById(btn.getAttribute('data-form-id'));
                    titleEl.textContent = btn.getAttribute('data-title') || 'Confirm';
                    msgEl.textContent = btn.getAttribute('data-message') || 'Are you sure?';
                    yesBtn.className = 'btn btn-' + (btn.getAttribute('data-variant') || 'primary');
                    bsModal.show();
                });
            });

            yesBtn.addEventListener('click', function () {
                if (targetForm) targetForm.submit();
            });
        });
    </script>
}
